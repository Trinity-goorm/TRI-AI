name: Build and Deploy to ECR - AI

on:
  push:
    branches:
      - main  # main ë¸Œëžœì¹˜ì— í‘¸ì‹œí•  ë•Œ ì‹¤í–‰

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: trinity-repo   # ìƒì„±í•œ ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
          IMAGE_TAG: ${{ github.sha }}    # ì»¤ë°‹ í•´ì‹œë¥¼ íƒœê·¸ë¡œ ì‚¬ìš©
        run: |
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Setup SSH config
        run: |
          mkdir -p ~/.ssh
          # Bastion í˜¸ìŠ¤íŠ¸ ì„¤ì •
          echo "Host bastion
            HostName 13.124.67.16
            User ec2-user
            IdentityFile ~/.ssh/toby-instance-key.pem" > ~/.ssh/config
          
          # í”„ë¼ì´ë¹— ì¸ìŠ¤í„´ìŠ¤(ml) ì„¤ì •
          echo "Host ml
            HostName 10.0.172.33
            User ec2-user
            ProxyJump bastion
            IdentityFile ~/.ssh/toby-instance-key.pem" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Set SSH key
        run: |
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/toby-instance-key.pem
          chmod 600 ~/.ssh/toby-instance-key.pem

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: '10.0.172.33'  # í”„ë¼ì´ë¹— ì¸ìŠ¤í„´ìŠ¤ IP
          username: ec2-user
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          proxy_host: '13.124.67.16'  # bastion í˜¸ìŠ¤íŠ¸ IP
          proxy_username: ec2-user
          proxy_key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            # EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}

            # ìž‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ec2-user/TRI-AI
            
            # .env íŒŒì¼ ìƒì„±
            cat > .env << INNEREOF

            # MongoDB Setting
            MONGO_HOST=${{ secrets.MONGO_HOST }}
            MONGO_PORT=${{ secrets.MONGO_PORT }}
            MONGO_USER=${{ secrets.MONGO_USER }}
            MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
            MONGO_DATABASE=${{ secrets.MONGO_DATABASE }}
            MONGO_COLLECTION=${{ secrets.MONGO_COLLECTION }}
            USE_SSH_TUNNEL=false
            INNEREOF

            # ìƒˆ ì´ë¯¸ì§€ pull
            docker pull ${{ steps.login-ecr.outputs.registry }}/trinity-repo:${{ github.sha }}

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±° (ì—†ìœ¼ë©´ ì—ëŸ¬ ë¬´ì‹œ)
            docker stop trinity-container || true
            docker rm trinity-container || true

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (í™˜ê²½ ë³€ìˆ˜ ì§ì ‘ ì „ë‹¬)
            docker run -d --name trinity-container \
              -p 5000:5000 \
              -e MONGO_HOST=${{ secrets.MONGO_HOST }} \
              -e MONGO_PORT=${{ secrets.MONGO_PORT }} \
              -e MONGO_USER=${{ secrets.MONGO_USER }} \
              -e MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }} \
              -e MONGO_DATABASE=${{ secrets.MONGO_DATABASE }} \
              -e MONGO_COLLECTION=${{ secrets.MONGO_COLLECTION }} \
              -e USE_SSH_TUNNEL=false \
              ${{ steps.login-ecr.outputs.registry }}/trinity-repo:${{ github.sha }}

      # Discord ì•Œë¦¼ ë³´ë‚´ê¸°
      - name: Send Discord Notification
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ðŸš€ ë°°í¬ ì™„ë£Œ!"
          description: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.event.head_commit.message }}
            ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
          color: 0x28A745 

      - name: Send Discord Notification on Failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âŒ ë°°í¬ ì‹¤íŒ¨!"
          description: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.event.head_commit.message }}
            ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
          color: 0xE01E5A
